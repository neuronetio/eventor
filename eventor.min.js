"use strict";function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Eventor=function(){function copyArray(source,array){return array=source.slice()}function pushArray(source,array){var index=-1,length=source.length;array||(array=Array(length));for(var last=array.length;++index<length;)array[last]=source[index],last++;return array}function pushObjAsArray(source,array){array||(array=Array(length));for(var keys=Object.keys(source),length=keys.length,index=-1,last=array.length;++index<length;)array[last]=source[keys[index]],last++;return array}function Eventor(opts){var root={};opts=opts||{};var sharedData={lastId:0};return opts._shared=sharedData,"undefined"!=typeof opts.promise?root.promise=opts.promise:root.promise=Promise,opts.root=root,root._useBefore=new EventorBasic(opts),root._normal=new EventorBasic(opts),root._useAfter=new EventorBasic(opts),root._useAfterAll=new EventorBasic(opts),root.on=function(){for(var _len5=arguments.length,args=Array(_len5),_key5=0;_key5<_len5;_key5++)args[_key5]=arguments[_key5];return root._normal.on.apply(root._normal,args)},root.removeListener=function(listenerId){if(listenerId=listenerId.toString(),Object.keys(root._normal._allListeners).indexOf(listenerId)>=0)return root._normal.removeListener.apply(root._normal,[listenerId]);if(Object.keys(root._useBefore._allListeners).indexOf(listenerId)>=0)return root._useBefore.removeListener.apply(root._useBefore,[listenerId]);if(Object.keys(root._useAfter._allListeners).indexOf(listenerId)>=0)return root._useAfter.removeListener.apply(root._useAfter,[listenerId]);if(Object.keys(root._useAfterAll._allListeners).indexOf(listenerId)>=0)return root._useAfterAll.removeListener.apply(root._useAfterAll,[listenerId]);var error=new Error("No listener found with specified id ["+listenerId+"]");throw error},root.useBefore=function(){for(var _len6=arguments.length,args=Array(_len6),_key6=0;_key6<_len6;_key6++)args[_key6]=arguments[_key6];return root._useBefore.on.apply(root._useBefore,args)},root.useAfter=function(){for(var _len7=arguments.length,args=Array(_len7),_key7=0;_key7<_len7;_key7++)args[_key7]=arguments[_key7];return root._useAfter.on.apply(root._useAfter,args)},root.useAfterAll=function(){for(var _len8=arguments.length,args=Array(_len8),_key8=0;_key8<_len8;_key8++)args[_key8]=arguments[_key8];return root._useAfterAll.on.apply(root._useAfterAll,args)},root.emit=function(){function normal(input){useBeforeParsed.data=input,useBeforeParsed.event={type:"emit",eventName:useBeforeParsed.eventName,nameSpace:useBeforeParsed.nameSpace,isUseBefore:!1,isUseAfter:!1,isUseAfterAll:!1};var useAfterParsedArgs=Object.assign({},useBeforeParsed);useAfterParsedArgs.data=void 0,useAfterParsedArgs.event={type:"emit",eventName:useAfterParsedArgs.eventName,nameSpace:useAfterParsedArgs.nameSpace,isUseBefore:!1,isUseAfter:!0,isUseAfterAll:!1};var after={_after:root._useAfter,parsedArgs:useAfterParsedArgs},p=void 0,afterListeners=void 0;afterListeners="undefined"!=typeof nameSpace?root._useAfter.listeners(nameSpace,eventName):root._useAfter.listeners(eventName),p=0===afterListeners.length?root._normal._emit(useBeforeParsed):root._normal._emit(useBeforeParsed,after);var afterAllListeners=void 0;return afterAllListeners="undefined"!=typeof nameSpace?root._useAfterAll.listeners(nameSpace,eventName):root._useAfterAll.listeners(eventName),afterAllListeners.length>0&&(p=p.then(function(results){var useAfterParsed=Object.assign({},useBeforeParsed);return useAfterParsed.data=results,useAfterParsed.event={type:"emit",eventName:useAfterParsed.eventName,nameSpace:useAfterParsed.nameSpace,isUseBefore:!1,isUseAfter:!1,isUseAfterAll:!0},root._useAfterAll._cascade(useAfterParsed)})),p}for(var _len9=arguments.length,args=Array(_len9),_key9=0;_key9<_len9;_key9++)args[_key9]=arguments[_key9];var useBeforeParsed=root._normal._parseArguments(args),eventName=useBeforeParsed.eventName,nameSpace=useBeforeParsed.nameSpace;useBeforeParsed.event={type:"emit",eventName:useBeforeParsed.eventName,nameSpace:useBeforeParsed.nameSpace,isUseBefore:!0,isUseAfter:!1,isUseAfterAll:!1};var listeners=void 0;listeners="undefined"==typeof nameSpace?root._useBefore.listeners(eventName):root._useBefore.listeners(nameSpace,eventName);var result=void 0;return result=0==listeners.length?normal(useBeforeParsed.data):root._useBefore._cascade(useBeforeParsed).then(normal)},root.cascade=function(){function normal(input){var normalParsed=Object.assign({},useBeforeParsed);return normalParsed.data=input,normalParsed.event={type:"cascade",eventName:normalParsed.eventName,nameSpace:normalParsed.nameSpace,isUseBefore:!1,isUseAfter:!1,isUseAfterAll:!1},root._normal._cascade(normalParsed)}function after(input){var useAfterParsed=Object.assign({},useBeforeParsed);return useAfterParsed.data=input,useAfterParsed.event={type:"cascade",eventName:useAfterParsed.eventName,nameSpace:useAfterParsed.nameSpace,isUseBefore:!1,isUseAfter:!0,isUseAfterAll:!1},root._useAfter._cascade(useAfterParsed)}function afterAll(input){var useAfterParsed=Object.assign({},useBeforeParsed);return useAfterParsed.data=input,useAfterParsed.event={type:"cascade",eventName:useAfterParsed.eventName,nameSpace:useAfterParsed.nameSpace,isUseBefore:!1,isUseAfter:!1,isUseAfterAll:!0},root._useAfterAll._cascade(useAfterParsed)}for(var _len10=arguments.length,args=Array(_len10),_key10=0;_key10<_len10;_key10++)args[_key10]=arguments[_key10];var useBeforeParsed=root._normal._parseArguments(args),nameSpace=useBeforeParsed.nameSpace,eventName=useBeforeParsed.eventName;useBeforeParsed.event={type:"cascade",eventName:useBeforeParsed.eventName,nameSpace:useBeforeParsed.nameSpace,isUseBefore:!0,isUseAfter:!1,isUseAfterAll:!1};var doBefore=!1,doAfter=!1,doAfterAll=!1;if("undefined"==typeof nameSpace){var beforeListeners=root._useBefore.listeners(eventName);beforeListeners.length>0&&(doBefore=!0);var afterListeners=root._useAfter.listeners(eventName);afterListeners.length>0&&(doAfter=!0);var afterAllListeners=root._useAfterAll.listeners(eventName);afterAllListeners.length>0&&(doAfterAll=!0)}else{var _beforeListeners=root._useBefore.listeners(nameSpace,eventName);_beforeListeners.length>0&&(doBefore=!0);var _afterListeners=root._useAfter.listeners(nameSpace,eventName);_afterListeners.length>0&&(doAfter=!0);var _afterAllListeners=root._useAfterAll.listeners(nameSpace,eventName);_afterAllListeners.length>0&&(doAfterAll=!0)}var p=void 0;return p=doBefore?root._useBefore._cascade(useBeforeParsed).then(normal):normal(useBeforeParsed.data),doAfter&&(p=p.then(after)),doAfterAll&&(p=p.then(afterAll)),p},root.listeners=function(){for(var _len11=arguments.length,args=Array(_len11),_key11=0;_key11<_len11;_key11++)args[_key11]=arguments[_key11];return root._normal.listeners.apply(root._normal,args)},root.allListeners=function(){for(var _len12=arguments.length,args=Array(_len12),_key12=0;_key12<_len12;_key12++)args[_key12]=arguments[_key12];return[].concat(_toConsumableArray(root._useBefore.listeners.apply(root._useBefore,args)),_toConsumableArray(root._normal.listeners.apply(root._normal,args)),_toConsumableArray(root._useAfter.listeners.apply(root._useAfter,args)),_toConsumableArray(root._useAfterAll.listeners.apply(root._useAfterAll,args)))},root.getNameSpaceListeners=function(){for(var _len13=arguments.length,args=Array(_len13),_key13=0;_key13<_len13;_key13++)args[_key13]=arguments[_key13];return root._normal.getNameSpaceListeners.apply(root._normal,args)},root.getAllNameSpaceListeners=function(){for(var _len14=arguments.length,args=Array(_len14),_key14=0;_key14<_len14;_key14++)args[_key14]=arguments[_key14];return[].concat(_toConsumableArray(root._useBefore.getNameSpaceListeners.apply(root._useBefore,args)),_toConsumableArray(root._normal.getNameSpaceListeners.apply(root._normal,args)),_toConsumableArray(root._useAfter.getNameSpaceListeners.apply(root._useAfter,args)),_toConsumableArray(root._useAfterAll.getNameSpaceListeners.apply(root._useAfterAll,args)))},root.removeNameSpaceListeners=function(){for(var _len15=arguments.length,args=Array(_len15),_key15=0;_key15<_len15;_key15++)args[_key15]=arguments[_key15];return root._normal.removeNameSpaceListeners.apply(root._normal,args)},root.removeAllNameSpaceListeners=function(){for(var _len16=arguments.length,args=Array(_len16),_key16=0;_key16<_len16;_key16++)args[_key16]=arguments[_key16];return root._normal.removeNameSpaceListeners.apply(root._normal,args)+root._useBefore.removeNameSpaceListeners.apply(root._useBefore,args)+root._useAfter.removeNameSpaceListeners.apply(root._useAfter,args)+root._useAfterAll.removeNameSpaceListeners.apply(root._useAfterAll,args)},root.wildcardMatchEventName=function(){for(var _len17=arguments.length,args=Array(_len17),_key17=0;_key17<_len17;_key17++)args[_key17]=arguments[_key17];return root._normal.wildcardMatchEventName.apply(root._normal,args)},root}function EventorConstructor(opts){var eventor=Eventor(opts);return eventor.before=Eventor(opts),eventor.after=eventor,eventor}var EventorBasic=function(){function EventorBasic(opts){if(_classCallCheck(this,EventorBasic),this._listeners={},this._allListeners={},this._wildcardListeners={},this._allWildcardListeners=[],this.delimeter=".",this._shared=opts._shared,"function"==typeof opts.errorEventsErrorHandler?this._errorEventsErrorHandler=opts.errorEventsErrorHandler:this._errorEventsErrorHandler=function(){},this.root=opts.root,"undefined"==typeof opts.promise?this.promise=Promise:this.promise=opts.promise,"string"==typeof opts.delimeter){if(opts.delimeter.length>1)throw new Error("Delimeter should be one character long.");this.delimeter=opts.delimeter}}return _createClass(EventorBasic,[{key:"generateId",value:function(){return++this._shared.lastId}},{key:"on",value:function(){for(var eventName="",callback=function(){},nameSpace="",isUseBefore=!1,isUseAfter=!1,isUseAfterAll=!1,emptyArgs=!1,_len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];if(args.forEach(function(arg){"undefined"!=typeof arg&&null!=arg||(emptyArgs=!0)}),emptyArgs)return!1;if("string"!=typeof args[0]&&"RegExp"!=args[0].constructor.name)throw new TypeError("First argument should be string or RegExp in Eventor.on method");if("function"==typeof args[1])eventName=args[0],callback=args[1],"string"==typeof args[2]&&("before"===args[2]&&(isUseBefore=!0),"after"===args[2]&&(isUseAfter=!0),"afterAll"===args[2]&&(isUseAfterAll=!0));else{if("string"!=typeof args[0]||"string"!=typeof args[1]&&"RegExp"!==args[1].constructor.name||"function"!=typeof args[2])throw new TypeError("Second argument should be string or function (callback) in Eventor.on method");nameSpace=args[0],eventName=args[1],callback=args[2],"string"==typeof args[3]&&("before"===args[3]&&(isUseBefore=!0),"after"===args[3]&&(isUseAfter=!0),"afterAll"===args[2]&&(isUseAfterAll=!0))}var wildcarded="RegExp"==eventName.constructor.name||eventName.indexOf("*")>=0,listenerId=this.generateId(),listener={id:listenerId,eventName:eventName,callback:callback,nameSpace:nameSpace,isWildcard:wildcarded,isUseBefore:isUseBefore,isUseAfter:isUseAfter,isUseAfterAll:isUseAfterAll};if(wildcarded){var regstr=eventName.toString();"undefined"==typeof this._wildcardListeners[regstr]&&(this._wildcardListeners[regstr]=[]),this._wildcardListeners[regstr].push(listener),this._allWildcardListeners.push(listener)}else"undefined"==typeof this._listeners[eventName]&&(this._listeners[eventName]=[]),this._listeners[eventName].push(listener);return this._allListeners[listenerId]=listener,listenerId}},{key:"removeListener",value:function(listenerId){var listener=this._allListeners[listenerId],eventName=listener.eventName;if(listener.isWildcard){var _pos=this._wildcardListeners[eventName].indexOf(listener);this._wildcardListeners[eventName].splice(_pos,1)}else{var pos=this._listeners[eventName].indexOf(listener);this._listeners[eventName].splice(pos,1)}delete this._allListeners[listenerId]}},{key:"off",value:function(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];return this.removeListener.apply(this,args)}},{key:"removeNameSpaceListeners",value:function(nameSpace){var _this=this,listeners=this.getNameSpaceListeners(nameSpace),ids=[];return listeners.forEach(function(listener){ids.push(listener.id)}),ids.forEach(function(id){_this.removeListener(id)}),ids.length}},{key:"wildcardMatchEventName",value:function(wildcard,eventName){if("string"==typeof wildcard){var str=wildcard.replace(/[^a-z0-9]{1}/gi,"\\$&").replace(/\\\*\\\*/gi,".*").replace(/\\\*/gi,"[^\\"+this.delimeter+"]*");str="^"+str+"$",wildcard=new RegExp(str)}return eventName.match(wildcard)}},{key:"_getListenersForEvent",value:function(eventName){var _this2=this;if(this._allWildcardListeners.length>0){var listeners=[];"undefined"!=typeof this._listeners[eventName]&&(listeners=copyArray(this._listeners[eventName]));var wildcarded=this._allWildcardListeners.filter(function(listener){return listener._tempMatches=_this2.wildcardMatchEventName(listener.eventName,eventName),null!=listener._tempMatches});return pushArray(wildcarded,listeners),listeners.sort(function(a,b){return a.id-b.id}),listeners}return"undefined"!=typeof this._listeners[eventName]?this._listeners[eventName]:[]}},{key:"_getListenersForEventFromArray",value:function(eventName,listeners){var _this3=this,filtered=[];return filtered=listeners.filter(function(listener){return listener.isWildcard?(listener._tempMatches=_this3.wildcardMatchEventName(listener.eventName,eventName),null!=listener._tempMatches):listener.eventName===eventName}),filtered.sort(function(a,b){return a.id-b.id})}},{key:"listeners",value:function listeners(){if(0===arguments.length){var all=[];return pushObjAsArray(this._allListeners,all),all}if(1==arguments.length)return this._getListenersForEvent(arguments.length<=0?void 0:arguments[0]);if(2==arguments.length){var listeners=this.getNameSpaceListeners(arguments.length<=0?void 0:arguments[0]);return this._getListenersForEventFromArray(arguments.length<=1?void 0:arguments[1],listeners)}}},{key:"getNameSpaceListeners",value:function(nameSpace){var all=this.listeners(),result=all.filter(function(listener){return listener.nameSpace===nameSpace});return result}},{key:"_parseArguments",value:function(args){var result={};if(result.eventName="",result.data=void 0,result.nameSpace=void 0,"string"!=typeof args[0])return!1;if(1==args.length)return!1;if(2==args.length)result.eventName=args[0],result.data=args[1];else{if(3!=args.length)throw new Error("Argument length is incorrect\n"+JSON.stringify(args));result.nameSpace=args[0],result.eventName=args[1],result.data=args[2]}return result}},{key:"_getListenersFromParsedArguments",value:function(parsedArgs){var listeners=[];return listeners="undefined"==typeof parsedArgs.nameSpace?this.listeners(parsedArgs.eventName):this.listeners(parsedArgs.nameSpace,parsedArgs.eventName)}},{key:"_handleError",value:function(error){var _this4=this,handleItOutsideTry=function(e){_this4._errorEventsErrorHandler(e)};try{this.root.emit("error",error).catch(handleItOutsideTry)}catch(e){handleItOutsideTry(e)}}},{key:"_emit",value:function(parsedArgs,after){var _this5=this,listeners=this._getListenersFromParsedArguments(parsedArgs);if(0==listeners.length)return this.promise.all([]);for(var results=[],len=listeners.length,i=-1;++i<len;){var listener=listeners[i],eventObj=Object.assign({},parsedArgs.event);eventObj.listener=listener,eventObj.matches=listener._tempMatches,delete listener._tempMatches;var promise=void 0;try{promise=listener.callback(parsedArgs.data,eventObj),promise instanceof this.promise&&promise.catch(function(e){"error"!=parsedArgs.eventName&&_this5._handleError(e)})}catch(e){if("error"==parsedArgs.eventName)throw e;this._handleError(e),promise=new this.promise(function(resolve,reject){reject(e)})}if("undefined"!=typeof after){var promiseAfter=void 0;promise instanceof this.promise?promiseAfter=promise.then(function(result){var parsed=Object.assign({},after.parsedArgs);return parsed.data=result,parsed.event=Object.assign({},parsed.event),after._after._cascade(parsed)}):(after.parsedArgs.data=promise,promiseAfter=after._after._cascade(after.parsedArgs)),results.push(promiseAfter)}else results.push(promise)}return this.promise.all(results)}},{key:"_validateArgs",value:function(args){var parsedArgs=this._parseArguments(args);return parsedArgs}},{key:"emit",value:function(){for(var _len3=arguments.length,args=Array(_len3),_key3=0;_key3<_len3;_key3++)args[_key3]=arguments[_key3];var parsedArgs=this._validateArgs(args);return parsedArgs.event={type:"emit",eventName:parsedArgs.eventName,nameSpace:parsedArgs.nameSpace,isUseBefore:parsedArgs.isUseBefore,isUseAfter:parsedArgs.isUseAfter,isUseAfterAll:parsedArgs.isUseAfterAll},this._emit(parsedArgs)}},{key:"_cascade",value:function(parsedArgs){var _this6=this,listeners=this._getListenersFromParsedArguments(parsedArgs),result=this.promise.resolve(parsedArgs.data);if(0==listeners.length)return result;for(var len=listeners.length,i=-1,_loop=function(){var listener=listeners[i];result=result.then(function(currentData){var eventObj=Object.assign({},parsedArgs.event);eventObj.listener=listener,eventObj.matches=listener._tempMatches,delete listener._tempMatches;var promise=void 0;try{promise=listener.callback(currentData,eventObj),promise instanceof _this6.promise&&promise.catch(function(e){"error"!=parsedArgs.eventName&&_this6._handleError(e)})}catch(e){return"error"!=parsedArgs.eventName&&_this6._handleError(e),new _this6.promise(function(resolve,reject){reject(e)})}return promise})};++i<len;)_loop();return result}},{key:"cascade",value:function(){for(var _len4=arguments.length,args=Array(_len4),_key4=0;_key4<_len4;_key4++)args[_key4]=arguments[_key4];var parsedArgs=this._validateArgs(args);return parsedArgs.event={type:"cascade",eventName:parsedArgs.eventName,nameSpace:parsedArgs.nameSpace,isUseBefore:parsedArgs.isUseBefore,isUseAfter:parsedArgs.isUseAfter,isUseAfterAll:parsedArgs.isUseAfterAll},this._cascade(parsedArgs)}}]),EventorBasic}();return EventorConstructor}();"undefined"!=typeof module&&"undefined"!=typeof module.exports&&(module.exports=Eventor),"undefined"!=typeof window&&(window.Eventor=Eventor);