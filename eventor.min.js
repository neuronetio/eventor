"use strict";function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Eventor=function(){function Eventor(opts){var root={};opts=opts||{};var sharedData={lastId:0};return opts._shared=sharedData,root._before=new EventorBasic(opts),root._normal=new EventorBasic(opts),root._after=new EventorBasic(opts),root._afterAll=new EventorBasic(opts),root.on=function(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return root._normal.on.apply(root._normal,args)},root.removeListener=function(listenerId){if(listenerId=listenerId.toString(),Object.keys(root._normal._allListeners).indexOf(listenerId)>=0)return root._normal.removeListener.apply(root._normal,[listenerId]);if(Object.keys(root._before._allListeners).indexOf(listenerId)>=0)return root._before.removeListener.apply(root._before,[listenerId]);if(Object.keys(root._after._allListeners).indexOf(listenerId)>=0)return root._after.removeListener.apply(root._after,[listenerId]);if(Object.keys(root._afterAll._allListeners).indexOf(listenerId)>=0)return root._afterAll.removeListener.apply(root._afterAll,[listenerId]);var error=new Error("No listener found with specified id ["+listenerId+"]");throw error},root.before=function(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];return root._before.on.apply(root._before,args)},root.after=function(){for(var _len3=arguments.length,args=Array(_len3),_key3=0;_key3<_len3;_key3++)args[_key3]=arguments[_key3];return root._after.on.apply(root._after,args)},root.afterAll=function(){for(var _len4=arguments.length,args=Array(_len4),_key4=0;_key4<_len4;_key4++)args[_key4]=arguments[_key4];return root._afterAll.on.apply(root._afterAll,args)},root.emit=function(){for(var _len5=arguments.length,args=Array(_len5),_key5=0;_key5<_len5;_key5++)args[_key5]=arguments[_key5];var beforeParsed=root._normal._parseArguments(args);return beforeParsed.event={type:"emit",eventName:beforeParsed.eventName,nameSpace:beforeParsed.nameSpace,isBefore:!0,isAfter:!1,isAfterAll:!1},root._before._cascade(beforeParsed).then(function(input){var normalParsed=Object.assign({},beforeParsed);normalParsed.data=input,normalParsed.event={type:"emit",eventName:normalParsed.eventName,nameSpace:normalParsed.nameSpace,isBefore:!1,isAfter:!1,isAfterAll:!1};var afterParsedArgs=Object.assign({},beforeParsed);afterParsedArgs.data=void 0,afterParsedArgs.event={type:"emit",eventName:afterParsedArgs.eventName,nameSpace:afterParsedArgs.nameSpace,isBefore:!1,isAfter:!0,isAfterAll:!1};var after={_after:root._after,parsedArgs:afterParsedArgs};return root._normal._emit(normalParsed,after)}).then(function(results){var afterParsed=Object.assign({},beforeParsed);return afterParsed.data=results,afterParsed.event={type:"emit",eventName:afterParsed.eventName,nameSpace:afterParsed.nameSpace,isBefore:!1,isAfter:!1,isAfterAll:!0},root._afterAll._cascade(afterParsed)})},root.cascade=function(){for(var _len6=arguments.length,args=Array(_len6),_key6=0;_key6<_len6;_key6++)args[_key6]=arguments[_key6];var beforeParsed=root._normal._parseArguments(args);return beforeParsed.event={type:"cascade",eventName:beforeParsed.eventName,nameSpace:beforeParsed.nameSpace,isBefore:!0,isAfter:!1,isAfterAll:!1},root._before._cascade(beforeParsed).then(function(input){var normalParsed=Object.assign({},beforeParsed);return normalParsed.data=input,normalParsed.event={type:"cascade",eventName:normalParsed.eventName,nameSpace:normalParsed.nameSpace,isBefore:!1,isAfter:!1,isAfterAll:!1},root._normal._cascade(normalParsed)}).then(function(results){var afterParsed=Object.assign({},beforeParsed);return afterParsed.data=results,afterParsed.event={type:"cascade",eventName:afterParsed.eventName,nameSpace:afterParsed.nameSpace,isBefore:!1,isAfter:!0,isAfterAll:!1},root._after._cascade(afterParsed)}).then(function(results){var afterParsed=Object.assign({},beforeParsed);return afterParsed.data=results,afterParsed.event={type:"cascade",eventName:afterParsed.eventName,nameSpace:afterParsed.nameSpace,isBefore:!1,isAfter:!1,isAfterAll:!0},root._afterAll._cascade(afterParsed)})},root.listeners=function(){for(var _len7=arguments.length,args=Array(_len7),_key7=0;_key7<_len7;_key7++)args[_key7]=arguments[_key7];return root._normal.listeners.apply(root._normal,args)},root.allListeners=function(){for(var _len8=arguments.length,args=Array(_len8),_key8=0;_key8<_len8;_key8++)args[_key8]=arguments[_key8];return[].concat(_toConsumableArray(root._before.listeners.apply(root._before,args)),_toConsumableArray(root._normal.listeners.apply(root._normal,args)),_toConsumableArray(root._after.listeners.apply(root._after,args)),_toConsumableArray(root._afterAll.listeners.apply(root._afterAll,args)))},root.getNameSpaceListeners=function(){for(var _len9=arguments.length,args=Array(_len9),_key9=0;_key9<_len9;_key9++)args[_key9]=arguments[_key9];return root._normal.getNameSpaceListeners.apply(root._normal,args)},root.getAllNameSpaceListeners=function(){for(var _len10=arguments.length,args=Array(_len10),_key10=0;_key10<_len10;_key10++)args[_key10]=arguments[_key10];return[].concat(_toConsumableArray(root._before.getNameSpaceListeners.apply(root._before,args)),_toConsumableArray(root._normal.getNameSpaceListeners.apply(root._normal,args)),_toConsumableArray(root._after.getNameSpaceListeners.apply(root._after,args)),_toConsumableArray(root._afterAll.getNameSpaceListeners.apply(root._afterAll,args)))},root.removeNameSpaceListeners=function(){for(var _len11=arguments.length,args=Array(_len11),_key11=0;_key11<_len11;_key11++)args[_key11]=arguments[_key11];return root._normal.removeNameSpaceListeners.apply(root._normal,args)},root.removeAllNameSpaceListeners=function(){for(var _len12=arguments.length,args=Array(_len12),_key12=0;_key12<_len12;_key12++)args[_key12]=arguments[_key12];return root._normal.removeNameSpaceListeners.apply(root._normal,args)+root._before.removeNameSpaceListeners.apply(root._before,args)+root._after.removeNameSpaceListeners.apply(root._after,args)+root._afterAll.removeNameSpaceListeners.apply(root._afterAll,args)},root.wildcardMatchEventName=function(){for(var _len13=arguments.length,args=Array(_len13),_key13=0;_key13<_len13;_key13++)args[_key13]=arguments[_key13];return root._normal.wildcardMatchEventName.apply(root._normal,args)},root}var EventorBasic=function(){function EventorBasic(opts){if(_classCallCheck(this,EventorBasic),this._listeners={},this._allListeners={},this._wildcardListeners={},this._allWildcardListeners=[],this.delimeter=".",this._shared=opts._shared,"string"==typeof opts.delimeter){if(opts.delimeter.length>1)throw new Error("Delimeter should be one character long.");this.delimeter=opts.delimeter}}return _createClass(EventorBasic,[{key:"generateId",value:function(){return++this._shared.lastId}},{key:"on",value:function(){var eventName="",callback=function(){},nameSpace="",args=Array.prototype.slice.call(arguments),isBefore=!1,isAfter=!1,isAfterAll=!1,emptyArgs=!1;if(args.forEach(function(arg){"undefined"!=typeof arg&&null!=arg||(emptyArgs=!0)}),emptyArgs)return!1;if("string"!=typeof args[0]&&"RegExp"!=args[0].constructor.name)throw new TypeError("First argument should be string or RegExp in Eventor.on method");if("function"==typeof args[1])eventName=args[0],callback=args[1],"string"==typeof args[2]&&("before"===args[2]&&(isBefore=!0),"after"===args[2]&&(isAfter=!0),"afterAll"===args[2]&&(isAfterAll=!0));else{if("string"!=typeof args[0]||"string"!=typeof args[1]&&"RegExp"!==args[1].constructor.name||"function"!=typeof args[2])throw new TypeError("Second argument should be string or function (callback) in Eventor.on method");nameSpace=args[0],eventName=args[1],callback=args[2],"string"==typeof args[3]&&("before"===args[3]&&(isBefore=!0),"after"===args[3]&&(isAfter=!0),"afterAll"===args[2]&&(isAfterAll=!0))}var wildcarded="RegExp"==eventName.constructor.name||eventName.indexOf("*")>=0,listenerId=this.generateId(),listener={id:listenerId,eventName:eventName,callback:callback,nameSpace:nameSpace,isWildcard:wildcarded,isBefore:isBefore,isAfter:isAfter,isAfterAll:isAfterAll};if(wildcarded){var regstr=eventName.toString();"undefined"==typeof this._wildcardListeners[regstr]&&(this._wildcardListeners[regstr]=[]),this._wildcardListeners[regstr].push(listener),this._allWildcardListeners.push(listener)}else"undefined"==typeof this._listeners[eventName]&&(this._listeners[eventName]=[]),this._listeners[eventName].push(listener);return this._allListeners[listenerId]=listener,listenerId}},{key:"removeListener",value:function(listenerId){var listener=this._allListeners[listenerId],eventName=listener.eventName;if(listener.isWildcard){var _pos=this._wildcardListeners[eventName].indexOf(listener);this._wildcardListeners[eventName].splice(_pos,1)}else{var pos=this._listeners[eventName].indexOf(listener);this._listeners[eventName].splice(pos,1)}delete this._allListeners[listenerId]}},{key:"off",value:function(){var args=Array.prototype.slice.call(arguments);return this.removeListener.apply(this,args)}},{key:"removeNameSpaceListeners",value:function(nameSpace){var _this=this,listeners=this.getNameSpaceListeners(nameSpace),ids=[];return listeners.forEach(function(listener){ids.push(listener.id)}),ids.forEach(function(id){_this.removeListener(id)}),ids.length}},{key:"wildcardMatchEventName",value:function(wildcard,eventName){if("string"==typeof wildcard){var str=wildcard.replace(/[^a-z0-9]{1}/gi,"\\$&").replace(/\\\*\\\*/gi,".*").replace(/\\\*/gi,"[^\\"+this.delimeter+"]*");str="^"+str+"$",wildcard=new RegExp(str)}return eventName.match(wildcard)}},{key:"_getListenersForEvent",value:function(eventName){var _this2=this,listeners=[];"undefined"!=typeof this._listeners[eventName]&&(listeners=this._listeners[eventName]);var wildcarded=this._allWildcardListeners.map(function(listener){return listener._tempMatches=_this2.wildcardMatchEventName(listener.eventName,eventName),listener}).filter(function(listener){return null!=listener._tempMatches});return listeners=[].concat(_toConsumableArray(listeners),_toConsumableArray(wildcarded)),listeners.sort(function(a,b){return a.id-b.id}),listeners}},{key:"_getListenersForEventFromArray",value:function(eventName,listeners){var _this3=this;return listeners.filter(function(listener){return listener.isWildcard?(listener._tempMatches=_this3.wildcardMatchEventName(listener.eventName,eventName),null!=listener._tempMatches):listener.eventName===eventName}).sort(function(a,b){return a.id-b.id})}},{key:"listeners",value:function listeners(){if(0===arguments.length){var all=[];for(var listenerId in this._allListeners)all.push(this._allListeners[listenerId]);return all}if(1==arguments.length)return this._getListenersForEvent(arguments.length<=0?void 0:arguments[0]);if(2==arguments.length){var listeners=this.getNameSpaceListeners(arguments.length<=0?void 0:arguments[0]);return this._getListenersForEventFromArray(arguments.length<=1?void 0:arguments[1],listeners)}}},{key:"getNameSpaceListeners",value:function(nameSpace){var all=this.listeners(),result=all.filter(function(listener){return listener.nameSpace===nameSpace});return result}},{key:"_parseArguments",value:function(args){var result={};if(result.eventName="",result.data=void 0,result.nameSpace=void 0,"string"!=typeof args[0])return!1;if(1==args.length)return!1;if(2==args.length)result.eventName=args[0],result.data=args[1];else{if(3!=args.length)return!1;result.nameSpace=args[0],result.eventName=args[1],result.data=args[2]}return result}},{key:"_getListenersFromParsedArguments",value:function(parsedArgs){var listeners=[];return"undefined"==typeof parsedArgs.nameSpace?listeners=this.listeners(parsedArgs.eventName):(listeners=this.listeners(parsedArgs.eventName),listeners=listeners.filter(function(listener){return listener.nameSpace===parsedArgs.nameSpace})),listeners}},{key:"_emit",value:function(parsedArgs,after){var results=[],listeners=this._getListenersFromParsedArguments(parsedArgs);return listeners.forEach(function(listener){var eventObj=Object.assign({},parsedArgs.event);eventObj.listener=listener,eventObj.matches=listener._tempMatches,delete listener._tempMatches;var promise=listener.callback(parsedArgs.data,eventObj);"undefined"!=typeof after&&(promise instanceof Promise?promise=promise.then(function(result){return after.parsedArgs.data=result,after._after._cascade(after.parsedArgs)}):(after.parsedArgs.data=promise,promise=after._after._cascade(after.parsedArgs))),results.push(promise)}),Promise.all(results)}},{key:"_validateArgs",value:function(args){var parsedArgs=this._parseArguments(args);return parsedArgs}},{key:"emit",value:function(){var args=Array.prototype.slice.call(arguments),parsedArgs=this._validateArgs(args);return parsedArgs.event={type:"emit",eventName:parsedArgs.eventName,nameSpace:parsedArgs.nameSpace,isBefore:parsedArgs.isBefore,isAfter:parsedArgs.isAfter,isAfterAll:parsedArgs.isAfterAll},this._emit(parsedArgs)}},{key:"_cascade",value:function(parsedArgs){var listeners=this._getListenersFromParsedArguments(parsedArgs),result=Promise.resolve(parsedArgs.data);return listeners.forEach(function(listener,index){result=result.then(function(currentData){var eventObj=Object.assign({},parsedArgs.event);return eventObj.listener=listener,eventObj.matches=listener._tempMatches,delete listener._tempMatches,listener.callback(currentData,eventObj)})}),result}},{key:"cascade",value:function(){var args=Array.prototype.slice.call(arguments),parsedArgs=this._validateArgs(args);return parsedArgs.event={type:"cascade",eventName:parsedArgs.eventName,nameSpace:parsedArgs.nameSpace,isBefore:parsedArgs.isBefore,isAfter:parsedArgs.isAfter,isAfterAll:parsedArgs.isAfterAll},this._cascade(parsedArgs)}}]),EventorBasic}();return Eventor}();"undefined"!=typeof module&&"undefined"!=typeof module.exports&&(module.exports=Eventor);